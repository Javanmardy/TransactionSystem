<!-- dashboard.html -->
<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">

    <!-- nav -->
    <nav class="bg-blue-600 text-white">
        <div class="container mx-auto flex justify-between items-center px-4 py-4">
            <h1 class="text-xl font-bold">Dashboard</h1>
            <div class="space-x-4">
                <a href="dashboard.html" class="hover:underline">Dashboard</a>
                <a href="reports.html" class="hover:underline">Reports</a>
                <button id="logoutBtn" class="bg-white/20 px-3 py-1 rounded hover:bg-white/30">Logout</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-6 flex-1">
        <!-- Summary cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white shadow rounded p-5">
                <h2 class="text-gray-600">Total&nbsp;Transactions</h2>
                <p id="totalTx" class="text-3xl font-bold">0</p>
            </div>
            <div class="bg-white shadow rounded p-5">
                <h2 class="text-gray-600">Success</h2>
                <p id="successTx" class="text-3xl font-bold text-green-600">0</p>
            </div>
            <div class="bg-white shadow rounded p-5">
                <h2 class="text-gray-600">Failed</h2>
                <p id="failedTx" class="text-3xl font-bold text-red-600">0</p>
            </div>
            <div class="bg-white shadow rounded p-5">
                <h2 class="text-gray-600">Current&nbsp;Balance</h2>
                <p id="currentBal" class="text-3xl font-bold text-blue-600">0</p>
            </div>
        </div>

        <!-- add transaction -->
        <section class="bg-white p-6 rounded-lg shadow space-y-4">
            <h2 class="text-xl font-bold">Add Transaction</h2>
            <form id="addTxForm" class="grid sm:grid-cols-3 gap-4 items-end">
                <input id="txAmount" type="number" placeholder="Amount" class="border p-2 rounded w-full" />
                <select id="txStatus" class="border p-2 rounded w-full">
                    <option value="success">success</option>
                    <option value="failed">failed</option>
                </select>
                <button class="bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Add</button>
            </form>
        </section>

        <!-- table -->
        <section class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-bold mb-4">Transactions</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-left">
                    <thead>
                        <tr class="border-b">
                            <th class="py-2 px-3">ID</th>
                            <th class="py-2 px-3">Amount</th>
                            <th class="py-2 px-3">Status</th>
                            <th class="py-2 px-3">Date</th>
                        </tr>
                    </thead>
                    <tbody id="txTableBody"></tbody>
                </table>
            </div>
        </section>

    </main>

    <footer class="bg-gray-100 py-4">
        <div class="container mx-auto text-center text-sm text-gray-600">© 2025 Transaction System Portal</div>
    </footer>

    <script>
        // === تنظیمات ثابت ===
        const API_BASE = '';                // با سرور هم‌مبدأ کار می‌کنیم
        const token = localStorage.getItem('token');
        if (!token) location.href = 'index.html';

        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        };

        // === کمکی: فرمت تاریخ ===
        function fmt(ts) {
            if (!ts) return '–';
            const d = new Date(ts);           // از created_at یا createdAt می‌آید
            if (isNaN(d)) return '–';
            return d.toLocaleString();        // خروجی مثل 7/18/2025, 9:32:01 PM
        }

        // === بارگذاری تراکنش‌ها و کارت‌ها ===
        async function loadReports() {
            try {
                const res = await fetch('/transactions', { headers });
                const list = await res.json();

                const bodyEl = document.getElementById('txTableBody');
                bodyEl.innerHTML = '';          // خالی کردن جدول

                let success = 0, failed = 0, balance = 0;

                list.forEach(tx => {
                    const when = tx.created_at || tx.createdAt || tx.date;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
          <td class="p-3 border-b">${tx.id}</td>
          <td class="p-3 border-b">${tx.amount}</td>
          <td class="p-3 border-b ${tx.status === 'success' ? 'text-green-600' : 'text-red-600'}">
            ${tx.status}
          </td>
          <td class="p-3 border-b">${fmt(when)}</td>
        `;
                    bodyEl.appendChild(tr);

                    if (tx.status === 'success') { success++; balance += Number(tx.amount); }
                    else { failed++; }
                });

                // به‌روزرسانی کارت‌های خلاصه
                document.getElementById('totalTx').textContent = list.length;
                document.getElementById('successTx').textContent = success;
                document.getElementById('failedTx').textContent = failed;
                document.getElementById('currentBal').textContent = balance;
            } catch (err) {
                console.error('Load error:', err);
            }
        }

        // === افزودن تراکنش ===
        document.getElementById('addTxForm').onsubmit = async e => {
            e.preventDefault();
            const body = {
                amount: Number(document.getElementById('txAmount').value),
                status: document.getElementById('txStatus').value
            };
            await fetch('/transactions', {
                method: 'POST', headers, body: JSON.stringify(body)
            });
            e.target.reset();
            loadReports();                    // جدول و کارت‌ها را رفرش کن
        };

        // === خروج از سیستم ===
        document.getElementById('logoutBtn').onclick = () => {
            localStorage.removeItem('token');
            location.href = 'index.html';
        };

        // === شروع ===
        loadReports();
    </script>

</body>

</html>